#!/bin/bash

# Gensyn RL-Swarm ç›‘æ§è„šæœ¬
# æ”¯æŒP2Pè¿æ¥é”™è¯¯å¤„ç†ã€è¿è¡ŒçŠ¶æ€ç›‘æ§ã€æŸ¥åˆ†æŠ¥è­¦ç­‰åŠŸèƒ½

set -euo pipefail

# =============================================================================
# é…ç½®åŒºåŸŸ
# =============================================================================

# åŸºç¡€è·¯å¾„é…ç½®
GENSYN_DIR="/root/rl-swarm"
LOG_FILE="/root/rl-swarm/logs/swarm_launcher.log"
VENV_PATH="/root/rl-swarm/myenv"
SCREEN_SESSION="gensyn"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MONITOR_LOG="$SCRIPT_DIR/monitor.log"
STATE_FILE="$SCRIPT_DIR/monitor_state.json"

# ç”µæŠ¥æœºå™¨äººé…ç½®
BOT_TOKEN="8095489389:AAGYdN-mBpiQdniKgEpFtnzC8wfHZAABE1o"
CHAT_ID="5519262792"

# ç›‘æ§é…ç½®
MAX_P2P_RETRIES=5
SCORE_CHECK_INTERVAL=3600  # 1å°æ—¶
SCORE_UNCHANGED_THRESHOLD=3  # è¿ç»­3å°æ—¶æ— å˜åŒ–è§¦å‘é‡å¯
HEALTH_CHECK_INTERVAL=300   # 5åˆ†é’Ÿå¥åº·æ£€æŸ¥
LOG_CHECK_INTERVAL=60       # 1åˆ†é’Ÿæ—¥å¿—æ£€æŸ¥

# é¢„è®¾åå•
VALID_NAMES=(
    "melodic playful slug"
    "giant deft giraffe"
    "strong scaly kingfisher"
    "enormous hulking crocodile"
    "vigilant soft flea"
    "secretive running raccoon"
    "tangled whistling frog"
    "coiled mammalian puffin"
    "rabid reptilian hippo"
    "yawning eager coyote"
    "peaceful gentle marmot"
    "peaceful mimic heron"
    "twitchy ravenous lemur"
    "bristly screeching chinchilla"
    "rabid reclusive stingray"
    "noisy robust chimpanzee"
    "fanged whistling caribou"
    "feathered tall chinchilla"
    "spotted coiled snake"
    "slow scurrying lizard"
    "stinging foraging cat"
    "bristly voracious worm"
    "chattering stealthy heron"
    "gregarious armored ladybug"
    "foxy endangered jackal"
    "grazing amphibious orangutan"
    "fishy flapping buffalo"
    "fleecy stealthy bison"
    "dextrous bellowing dragonfly"
    "thorny agile mandrill"
)

# =============================================================================
# å·¥å…·å‡½æ•°
# =============================================================================

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$MONITOR_LOG"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" | tee -a "$MONITOR_LOG" >&2
}

log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1" | tee -a "$MONITOR_LOG"
}

log_warn() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARN: $1" | tee -a "$MONITOR_LOG"
}

# ç”µæŠ¥æ¨é€å‡½æ•°
send_telegram_message() {
    local message="$1"
    
    # è·å–å½“å‰èŠ‚ç‚¹åç§°
    local current_peer_name=""
    local state=$(load_state)
    current_peer_name=$(echo "$state" | grep -oP '"peer_name":\s*"\K[^"]*' 2>/dev/null || echo "")
    
    # å¦‚æœçŠ¶æ€æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°èŠ‚ç‚¹åç§°ï¼Œå°è¯•ä»æ—¥å¿—ä¸­æå–
    if [[ -z "$current_peer_name" ]]; then
        current_peer_name=$(extract_peer_name)
    fi
    
    # å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œè®¾ç½®ä¸ºæœªçŸ¥
    if [[ -z "$current_peer_name" ]]; then
        current_peer_name="æœªçŸ¥"
    fi
    
    local result=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d text="ğŸš¨ Gensyn Monitor Alert ğŸš¨

$message

ğŸ“ èŠ‚ç‚¹ä¿¡æ¯:
â€¢ èŠ‚ç‚¹åç§°: $current_peer_name
â€¢ ä¸»æœºåç§°: $(hostname)
â€¢ ä¸»æœºIP: $(hostname -I | awk '{print $1}' 2>/dev/null || echo "è·å–å¤±è´¥")

ğŸ• æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')")
    
    if [[ $result == *"\"ok\":true"* ]]; then
        log_info "ç”µæŠ¥æ¶ˆæ¯å‘é€æˆåŠŸ [èŠ‚ç‚¹: $current_peer_name]"
    else
        log_error "ç”µæŠ¥æ¶ˆæ¯å‘é€å¤±è´¥: $result"
    fi
}

# æ£€æŸ¥ç½‘ç»œè¿æ¥
check_network_connectivity() {
    # æ£€æŸ¥æ˜¯å¦èƒ½è¿æ¥åˆ°Google DNS
    if ping -c 1 8.8.8.8 &> /dev/null; then
        return 0  # ç½‘ç»œæ­£å¸¸
    fi
    
    # æ£€æŸ¥æ˜¯å¦èƒ½è¿æ¥åˆ°Gensyn API
    if curl -s --connect-timeout 5 --max-time 10 "https://dashboard.gensyn.ai" &> /dev/null; then
        return 0  # ç½‘ç»œæ­£å¸¸
    fi
    
    return 1  # ç½‘ç»œå¼‚å¸¸
}

# çŠ¶æ€æ–‡ä»¶ç®¡ç†
save_state() {
    local peer_name="$1"
    local last_score="$2"
    local last_check_time="$3"
    local unchanged_count="$4"
    local last_reward="${5:-}"
    local startup_time="${6:-}"
    
    # å¦‚æœæ²¡æœ‰æä¾›å¯åŠ¨æ—¶é—´ï¼Œå°è¯•è·å–æœ€æ–°çš„å¯åŠ¨æ—¶é—´
    if [[ -z "$startup_time" ]]; then
        startup_time=$(get_last_startup_time)
    fi
    
    cat > "$STATE_FILE" << EOF
{
    "peer_name": "$peer_name",
    "last_score": "$last_score",
    "last_reward": "$last_reward",
    "last_check_time": "$last_check_time",
    "unchanged_count": $unchanged_count,
    "last_restart_time": "$(date '+%Y-%m-%d %H:%M:%S')",
    "last_startup_time": "$startup_time"
}
EOF
}

load_state() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo '{"peer_name": "", "last_score": "", "last_reward": "", "last_check_time": "", "unchanged_count": 0, "last_restart_time": "", "last_startup_time": "0"}'
    fi
}

# æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å¯åŠ¨ï¼ˆåŸºäºå¯åŠ¨æ—¶é—´ï¼‰
check_new_startup() {
    local current_startup_time=$(get_last_startup_time)
    local state=$(load_state)
    local saved_startup_time=$(echo "$state" | grep -oP '"last_startup_time":\s*"\K[^"]*')
    
    # å¦‚æœå¯åŠ¨æ—¶é—´ä¸ä¸€è‡´ï¼Œè¯´æ˜æœ‰æ–°çš„å¯åŠ¨
    if [[ "$current_startup_time" != "$saved_startup_time" ]]; then
        return 0  # æœ‰æ–°å¯åŠ¨
    fi
    return 1  # æ²¡æœ‰æ–°å¯åŠ¨
}

# =============================================================================
# Screen ä¼šè¯ç®¡ç†
# =============================================================================

# æ£€æŸ¥screenä¼šè¯æ˜¯å¦å­˜åœ¨
check_screen_session() {
    screen -list | grep -q "gensyn" 2>/dev/null
}

# åˆ›å»ºscreenä¼šè¯
create_screen_session() {
    log_info "åˆ›å»ºæ–°çš„screenä¼šè¯: $SCREEN_SESSION"
    cd "$GENSYN_DIR"
    screen -dmS "$SCREEN_SESSION"
    sleep 2
    
    # åœ¨screenä¸­è®¾ç½®ç¯å¢ƒå¹¶å¯åŠ¨è„šæœ¬
    screen -S "$SCREEN_SESSION" -X stuff "cd $GENSYN_DIR\n"
    sleep 1
    screen -S "$SCREEN_SESSION" -X stuff "source $VENV_PATH/bin/activate\n"
    sleep 1
    screen -S "$SCREEN_SESSION" -X stuff "./run_rl_swarm.sh\n"
    
    log_info "Screenä¼šè¯å·²åˆ›å»ºå¹¶å¯åŠ¨gensynè„šæœ¬"
}

# åœ¨screenå†…éƒ¨é‡å¯ï¼ˆä¸é‡æ–°åˆ›å»ºscreenä¼šè¯ï¼‰
restart_in_screen() {
    log_info "åœ¨screenä¼šè¯å†…éƒ¨é‡å¯gensynè„šæœ¬"
    
    # å‘é€Ctrl+Cç»ˆæ­¢å½“å‰è¿›ç¨‹
    screen -S "$SCREEN_SESSION" -X stuff "\003"
    sleep 3
    
    # å‘é€å¤šä¸ªCtrl+Cç¡®ä¿å®Œå…¨ç»ˆæ­¢
    screen -S "$SCREEN_SESSION" -X stuff "\003"
    sleep 2
    
    # æ¸…ç†å¯èƒ½æ®‹ç•™çš„è¿›ç¨‹
    pkill -f "python.*rgym" 2>/dev/null || true
    pkill -f "yarn.*start" 2>/dev/null || true
    sleep 2
    
    # é‡æ–°å¯åŠ¨è„šæœ¬
    screen -S "$SCREEN_SESSION" -X stuff "cd $GENSYN_DIR && source $VENV_PATH/bin/activate\n"
    sleep 1
    screen -S "$SCREEN_SESSION" -X stuff "./run_rl_swarm.sh\n"
    
    log_info "å·²åœ¨screenå†…éƒ¨é‡å¯gensynè„šæœ¬"
}

# å¼ºåˆ¶é‡å¯screenä¼šè¯ï¼ˆæœ€åæ‰‹æ®µï¼‰
force_restart_screen() {
    log_warn "å¼ºåˆ¶é‡å¯screenä¼šè¯"
    
    # ç»ˆæ­¢screenä¼šè¯
    screen -S "$SCREEN_SESSION" -X quit 2>/dev/null || true
    sleep 2
    
    # æ¸…ç†æ®‹ç•™è¿›ç¨‹
    pkill -f "python.*rgym" 2>/dev/null || true
    pkill -f "yarn.*start" 2>/dev/null || true
    sleep 3
    
    # é‡æ–°åˆ›å»ºscreenä¼šè¯
    create_screen_session
    
    log_info "Screenä¼šè¯å·²å¼ºåˆ¶é‡å¯"
}

# =============================================================================
# çŠ¶æ€æ£€æµ‹å‡½æ•°
# =============================================================================

# æ£€æµ‹P2Pè¿æ¥é”™è¯¯
check_p2p_error() {
    if [[ -f "$LOG_FILE" ]]; then
        # æ£€æŸ¥æœ€è¿‘çš„P2Pé”™è¯¯
        if tail -100 "$LOG_FILE" | grep -q "P2PDaemonError.*Daemon failed to start"; then
            return 0  # å‘ç°P2Pé”™è¯¯
        fi
    fi
    return 1  # æ²¡æœ‰P2Pé”™è¯¯
}

# æ£€æµ‹å¯åŠ¨æˆåŠŸæ ‡å¿—
check_startup_success() {
    if [[ -f "$LOG_FILE" ]]; then
        # æ£€æŸ¥æ•´ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­æ˜¯å¦æœ‰å¯åŠ¨æˆåŠŸæ ‡å¿—
        local success_line=$(grep "ğŸ± Hello ğŸˆ \[.*\] ğŸ¦®" "$LOG_FILE" | tail -1)
        if [[ -n "$success_line" ]]; then
            # è¿›ä¸€æ­¥æ£€æŸ¥ï¼šç¡®ä¿è¿›ç¨‹ä»åœ¨è¿è¡Œ
            if check_process_running; then
                return 0  # å¯åŠ¨æˆåŠŸä¸”è¿›ç¨‹åœ¨è¿è¡Œ
            fi
        fi
    fi
    return 1  # å¯åŠ¨æœªæˆåŠŸ
}

# æå–åŠ¨ç‰©åç§°å’Œå¯åŠ¨æ—¶é—´
extract_peer_name() {
    if [[ -f "$LOG_FILE" ]]; then
        # åœ¨æ•´ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­æŸ¥æ‰¾å¯åŠ¨æ ‡å¿—ï¼Œè·å–æœ€è¿‘ä¸€æ¬¡
        local line=$(grep "ğŸ± Hello ğŸˆ \[.*\] ğŸ¦®" "$LOG_FILE" | tail -1)
        if [[ -n "$line" ]]; then
            # ä½¿ç”¨sedæå–æ–¹æ‹¬å·å†…çš„å†…å®¹
            echo "$line" | sed 's/.*ğŸ± Hello ğŸˆ \[\([^]]*\)\] ğŸ¦®.*/\1/' | head -1
        else
            echo ""
        fi
    else
        echo ""
    fi
}

# è·å–æœ€è¿‘ä¸€æ¬¡å¯åŠ¨çš„æ—¶é—´æˆ³
get_last_startup_time() {
    if [[ -f "$LOG_FILE" ]]; then
        # è·å–æœ€è¿‘ä¸€æ¬¡å¯åŠ¨æ ‡å¿—çš„æ—¶é—´
        local line=$(grep "ğŸ± Hello ğŸˆ \[.*\] ğŸ¦®" "$LOG_FILE" | tail -1)
        if [[ -n "$line" ]]; then
            # æå–æ—¶é—´æˆ³
            local log_time=$(echo "$line" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' | head -1)
            if [[ -n "$log_time" ]]; then
                date -d "$log_time" +%s 2>/dev/null || echo "0"
            else
                echo "0"
            fi
        else
            echo "0"
        fi
    else
        echo "0"
    fi
}

# æ£€æŸ¥åŠ¨ç‰©åç§°æ˜¯å¦åœ¨é¢„è®¾åå•ä¸­
validate_peer_name() {
    local peer_name="$1"
    for valid_name in "${VALID_NAMES[@]}"; do
        if [[ "$peer_name" == "$valid_name" ]]; then
            return 0  # åç§°æœ‰æ•ˆ
        fi
    done
    return 1  # åç§°æ— æ•ˆ
}

# æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œ
check_process_running() {
    if ps aux | grep -q "python.*rgym" && ps aux | grep -q "yarn.*start"; then
        return 0  # è¿›ç¨‹æ­£åœ¨è¿è¡Œ
    fi
    return 1  # è¿›ç¨‹æœªè¿è¡Œ
}

# æ£€æŸ¥è®­ç»ƒæ˜¯å¦æ­£å¸¸è¿›è¡Œ
check_training_progress() {
    if [[ -f "$LOG_FILE" ]]; then
        local current_time=$(date +%s)
        local last_startup_time=$(get_last_startup_time)
        
        # æ£€æŸ¥ç›‘æ§è„šæœ¬æ˜¯å¦åˆšå¯åŠ¨ï¼ˆç»™5åˆ†é’Ÿå®½æ¾æœŸï¼‰
        local state=$(load_state)
        local monitor_start_time=$(echo "$state" | grep -oP '"last_restart_time":\s*"\K[^"]*')
        if [[ -n "$monitor_start_time" ]]; then
            local monitor_timestamp=$(date -d "$monitor_start_time" +%s 2>/dev/null || echo "0")
            local monitor_running_time=$((current_time - monitor_timestamp))
            
            # å¦‚æœç›‘æ§è„šæœ¬è¿è¡Œä¸åˆ°5åˆ†é’Ÿï¼Œä½¿ç”¨å®½æ¾æ£€æŸ¥
            if [[ $monitor_running_time -lt 300 ]]; then
                log_info "ç›‘æ§è„šæœ¬åˆšå¯åŠ¨ï¼Œä½¿ç”¨å®½æ¾çš„è®­ç»ƒè¿›åº¦æ£€æŸ¥"
                local recent_logs=$(tail -100 "$LOG_FILE" | grep -E "Starting round|Joining round|ğŸ Joining round|Already finished round" | tail -5)
                if [[ -n "$recent_logs" ]]; then
                    return 0  # æœ‰è®­ç»ƒç›¸å…³æ—¥å¿—ï¼Œè®¤ä¸ºæ­£å¸¸
                fi
                # ç»§ç»­åé¢çš„è¯¦ç»†æ£€æŸ¥
            fi
        fi
        
        # å¦‚æœæ— æ³•è·å–å¯åŠ¨æ—¶é—´ï¼Œä½¿ç”¨ä¼ ç»Ÿæ£€æŸ¥æ–¹å¼
        if [[ "$last_startup_time" == "0" ]]; then
            local recent_logs=$(tail -100 "$LOG_FILE" | grep -E "Starting round|Joining round|ğŸ Joining round" | tail -5)
            if [[ -n "$recent_logs" ]]; then
                return 0  # æœ‰è®­ç»ƒæ—¥å¿—ï¼Œè®¤ä¸ºæ­£å¸¸
            fi
            return 1  # è®­ç»ƒå¼‚å¸¸
        fi
        
        # è·å–æœ€è¿‘å¯åŠ¨ä¹‹åçš„æ‰€æœ‰è®­ç»ƒæ—¥å¿—
        local startup_date=$(date -d "@$last_startup_time" '+%Y-%m-%d %H:%M:%S')
        log_info "æ£€æŸ¥è®­ç»ƒè¿›åº¦ï¼šå¯åŠ¨æ—¶é—´ $startup_date ä¹‹åçš„è®­ç»ƒæ—¥å¿—"
        
        # ä½¿ç”¨awkæ¥è·å–å¯åŠ¨æ—¶é—´ä¹‹åçš„è®­ç»ƒæ—¥å¿—
        local training_logs_after_startup=$(awk -v start_time="$startup_date" '
            BEGIN { found = 0 }
            $0 ~ /Starting round|Joining round|ğŸ Joining round/ && $0 >= start_time { found = 1 }
            found && /Starting round|Joining round|ğŸ Joining round/ { print }
        ' "$LOG_FILE" | tail -5)
        
        log_info "æ‰¾åˆ° $(echo "$training_logs_after_startup" | wc -l) æ¡å¯åŠ¨åçš„è®­ç»ƒæ—¥å¿—"
        
        if [[ -n "$training_logs_after_startup" ]]; then
            # æ£€æŸ¥æœ€åä¸€æ¡è®­ç»ƒæ—¥å¿—çš„æ—¶é—´
            local last_training_log=$(echo "$training_logs_after_startup" | tail -1)
            local log_time=$(echo "$last_training_log" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' | head -1)
            
            if [[ -n "$log_time" ]]; then
                local log_timestamp=$(date -d "$log_time" +%s 2>/dev/null || echo "0")
                local time_diff=$((current_time - log_timestamp))
                
                # å¦‚æœæœ€åä¸€æ¡è®­ç»ƒæ—¥å¿—åœ¨30åˆ†é’Ÿå†…ï¼Œè®¤ä¸ºè®­ç»ƒæ­£å¸¸ï¼ˆæ”¾å®½æ—¶é—´é™åˆ¶ï¼‰
                if [[ $time_diff -lt 1800 ]]; then
                    log_info "æœ€åè®­ç»ƒæ—¥å¿—æ—¶é—´å·®: ${time_diff}ç§’ï¼Œè®­ç»ƒæ­£å¸¸"
                    return 0  # è®­ç»ƒæ­£å¸¸
                else
                    log_warn "æœ€åè®­ç»ƒæ—¥å¿—æ—¶é—´å·®: ${time_diff}ç§’ï¼Œè¶…è¿‡30åˆ†é’Ÿé˜ˆå€¼"
                fi
            fi
        fi
        
        # æ£€æŸ¥æœ€è¿‘å¯åŠ¨åæ˜¯å¦æœ‰"Already finished round"æ—¥å¿—
        local finished_logs_after_startup=$(awk -v start_time="$startup_date" '
            BEGIN { found = 0 }
            $0 ~ /Already finished round/ && $0 >= start_time { found = 1 }
            found && /Already finished round/ { print }
        ' "$LOG_FILE" | tail -10)
        
        if [[ -n "$finished_logs_after_startup" ]]; then
            # æ£€æŸ¥æœ€åä¸€æ¡å®Œæˆæ—¥å¿—çš„æ—¶é—´
            local last_finished_log=$(echo "$finished_logs_after_startup" | tail -1)
            local log_time=$(echo "$last_finished_log" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' | head -1)
            
            if [[ -n "$log_time" ]]; then
                local log_timestamp=$(date -d "$log_time" +%s 2>/dev/null || echo "0")
                local time_diff=$((current_time - log_timestamp))
                
                # å¦‚æœæœ€åä¸€æ¡å®Œæˆæ—¥å¿—åœ¨30åˆ†é’Ÿå†…ï¼Œä¹Ÿè®¤ä¸ºæ˜¯æ­£å¸¸çš„ï¼ˆæ”¾å®½æ—¶é—´é™åˆ¶ï¼‰
                if [[ $time_diff -lt 1800 ]]; then
                    return 0  # è®­ç»ƒæ­£å¸¸
                fi
            fi
        fi
    fi
    return 1  # è®­ç»ƒå¼‚å¸¸
}

# æ£€æŸ¥å†…å­˜æˆ–å…¶ä»–ä¸¥é‡é”™è¯¯
check_critical_errors() {
    if [[ -f "$LOG_FILE" ]]; then
        # æ£€æŸ¥æœ€è¿‘çš„ä¸¥é‡é”™è¯¯
        if tail -50 "$LOG_FILE" | grep -qE "OutOfMemoryError|MemoryError|Fatal|Segmentation fault|killed"; then
            return 0  # å‘ç°ä¸¥é‡é”™è¯¯
        fi
        
        # æ£€æŸ¥Hydraç›¸å…³é”™è¯¯
        if tail -50 "$LOG_FILE" | grep -qE "hydra\.errors\.InstantiationException|Error in call to target|FileNotFoundError.*No such file or directory"; then
            log_error "æ£€æµ‹åˆ°Hydraé…ç½®æˆ–æ–‡ä»¶ç¼ºå¤±é”™è¯¯"
            return 0  # å‘ç°é…ç½®é”™è¯¯
        fi
        
        # æ£€æŸ¥Pythonè¿è¡Œæ—¶é”™è¯¯
        if tail -50 "$LOG_FILE" | grep -qE "Traceback \(most recent call last\)|ModuleNotFoundError|ImportError|AttributeError"; then
            log_error "æ£€æµ‹åˆ°Pythonè¿è¡Œæ—¶é”™è¯¯"
            return 0  # å‘ç°Pythoné”™è¯¯
        fi
        
        # æ£€æŸ¥è¿›ç¨‹æ„å¤–é€€å‡º
        if tail -50 "$LOG_FILE" | grep -qE "Terminated|Killed|Process finished with exit code|KeyboardInterrupt"; then
            log_error "æ£€æµ‹åˆ°è¿›ç¨‹æ„å¤–é€€å‡º"
            return 0  # å‘ç°è¿›ç¨‹é€€å‡º
        fi
    fi
    return 1  # æ²¡æœ‰ä¸¥é‡é”™è¯¯
}

# æ£€æŸ¥ç¨‹åºè¿è¡Œç¨³å®šæ€§ï¼ˆæ˜¯å¦é¢‘ç¹é‡å¯æˆ–å´©æºƒï¼‰
check_runtime_stability() {
    if [[ -f "$LOG_FILE" ]]; then
        local current_time=$(date +%s)
        local last_startup_time=$(get_last_startup_time)
        
        # å¦‚æœæ— æ³•è·å–å¯åŠ¨æ—¶é—´ï¼Œè·³è¿‡æ£€æŸ¥
        if [[ "$last_startup_time" == "0" ]]; then
            return 0  # æ— æ³•ç¡®å®šï¼Œè®¤ä¸ºæ­£å¸¸
        fi
        
        local runtime=$((current_time - last_startup_time))
        
        # å¦‚æœç¨‹åºè¿è¡Œæ—¶é—´å°‘äº5åˆ†é’Ÿï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
        if [[ $runtime -lt 300 ]]; then
            log_info "ç¨‹åºè¿è¡Œæ—¶é—´è¾ƒçŸ­ï¼ˆ${runtime}ç§’ï¼‰ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯"
            
            # è·å–å¯åŠ¨åçš„é”™è¯¯æ—¥å¿—
            local startup_date=$(date -d "@$last_startup_time" '+%Y-%m-%d %H:%M:%S')
            local recent_errors=$(awk -v start_time="$startup_date" '
                $0 >= start_time && /ERROR|Error|Exception|Traceback|Failed|failed/ { print }
            ' "$LOG_FILE" | tail -10)
            
            if [[ -n "$recent_errors" ]]; then
                log_error "æ£€æµ‹åˆ°å¯åŠ¨åçš„é”™è¯¯æ—¥å¿—ï¼Œç¨‹åºå¯èƒ½ä¸ç¨³å®š"
                echo "$recent_errors" | head -5 | while read line; do
                    log_error "é”™è¯¯è¯¦æƒ…: $line"
                done
                return 1  # è¿è¡Œä¸ç¨³å®š
            fi
        fi
        
        # æ£€æŸ¥æœ€è¿‘æ˜¯å¦æœ‰å¤šæ¬¡å¯åŠ¨ï¼ˆé¢‘ç¹é‡å¯ï¼‰
        local startup_count=$(grep -c "ğŸ± Hello ğŸˆ" "$LOG_FILE" | tail -1)
        if [[ $startup_count -gt 3 ]]; then
            # æ£€æŸ¥æœ€è¿‘1å°æ—¶å†…çš„å¯åŠ¨æ¬¡æ•°
            local one_hour_ago=$(date -d "1 hour ago" '+%Y-%m-%d %H:%M:%S')
            local recent_startups=$(awk -v start_time="$one_hour_ago" '
                $0 >= start_time && /ğŸ± Hello ğŸˆ/ { print }
            ' "$LOG_FILE" | wc -l)
            
            if [[ $recent_startups -gt 2 ]]; then
                log_error "æ£€æµ‹åˆ°é¢‘ç¹é‡å¯ï¼šæœ€è¿‘1å°æ—¶å†…å¯åŠ¨äº†${recent_startups}æ¬¡"
                return 1  # é¢‘ç¹é‡å¯
            fi
        fi
    fi
    return 0  # è¿è¡Œç¨³å®š
}

# æ£€æŸ¥æ˜¯å¦å¡åœ¨ç­‰å¾…èº«ä»½æ–‡ä»¶é˜¶æ®µ
check_identity_stuck() {
    if [[ -f "$LOG_FILE" ]]; then
        local recent_logs=$(tail -20 "$LOG_FILE")
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…èº«ä»½æ–‡ä»¶çš„æ—¥å¿—
        if echo "$recent_logs" | grep -q "Waiting for modal userData.json to be created"; then
            # è¿›ä¸€æ­¥æ£€æŸ¥æ˜¯å¦çœŸçš„å¡ä½äº†ï¼ˆæœ€è¿‘5åˆ†é’Ÿå†…æœ‰è¿™ä¸ªæ—¥å¿—ï¼‰
            local waiting_line=$(echo "$recent_logs" | grep "Waiting for modal userData.json to be created" | tail -1)
            if [[ -n "$waiting_line" ]]; then
                local log_time=$(echo "$waiting_line" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' | head -1)
                if [[ -n "$log_time" ]]; then
                    local log_timestamp=$(date -d "$log_time" +%s 2>/dev/null || echo "0")
                    local current_time=$(date +%s)
                    local time_diff=$((current_time - log_timestamp))
                    
                    # å¦‚æœç­‰å¾…èº«ä»½æ–‡ä»¶çš„æ—¥å¿—åœ¨5åˆ†é’Ÿå†…ï¼Œè®¤ä¸ºå¯èƒ½å¡ä½äº†
                    if [[ $time_diff -lt 300 ]] && [[ $time_diff -gt 30 ]]; then
                        return 0  # å¡åœ¨èº«ä»½æ–‡ä»¶é˜¶æ®µ
                    fi
                fi
            fi
        fi
    fi
    return 1  # æ²¡æœ‰å¡ä½
}

# è‡ªåŠ¨å¤åˆ¶èº«ä»½æ–‡ä»¶
auto_copy_identity_files() {
    log_info "æ£€æµ‹åˆ°èº«ä»½æ–‡ä»¶ç­‰å¾…è¶…æ—¶ï¼Œå°è¯•è‡ªåŠ¨å¤åˆ¶å¤‡ä»½æ–‡ä»¶"
    
    # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [[ -f "/root/rl-swarm-backup/userApiKey.json" ]] && [[ -f "/root/rl-swarm-backup/userData.json" ]]; then
        log_info "æ‰¾åˆ°å¤‡ä»½èº«ä»½æ–‡ä»¶ï¼Œå¼€å§‹å¤åˆ¶..."
        
        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p "$GENSYN_DIR/modal-login/temp-data"
        
        # å¤åˆ¶æ–‡ä»¶
        if cp /root/rl-swarm-backup/userApiKey.json "$GENSYN_DIR/modal-login/temp-data/" && \
           cp /root/rl-swarm-backup/userData.json "$GENSYN_DIR/modal-login/temp-data/"; then
            log_info "èº«ä»½æ–‡ä»¶å¤åˆ¶æˆåŠŸï¼"
            
            # è®¾ç½®é€‚å½“çš„æƒé™
            chmod 644 "$GENSYN_DIR/modal-login/temp-data/userApiKey.json"
            chmod 644 "$GENSYN_DIR/modal-login/temp-data/userData.json"
            
            send_telegram_message "èº«ä»½æ–‡ä»¶è‡ªåŠ¨å¤åˆ¶æˆåŠŸ
å¤‡ä»½æ–‡ä»¶å·²å¤åˆ¶åˆ° modal-login/temp-data/
ç¨‹åºåº”è¯¥å¾ˆå¿«æ¢å¤æ­£å¸¸è¿è¡Œ"
            
            return 0  # å¤åˆ¶æˆåŠŸ
        else
            log_error "èº«ä»½æ–‡ä»¶å¤åˆ¶å¤±è´¥"
            return 1  # å¤åˆ¶å¤±è´¥
        fi
    else
        log_error "å¤‡ä»½èº«ä»½æ–‡ä»¶ä¸å­˜åœ¨ï¼š/root/rl-swarm-backup/"
        send_telegram_message "èº«ä»½æ–‡ä»¶å¡ä½ï¼Œä½†å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨
è¯·æ‰‹åŠ¨æ£€æŸ¥ /root/rl-swarm-backup/ ç›®å½•
æˆ–è€…æ‰‹åŠ¨ç™»å½• http://localhost:3000"
        return 1  # å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨
    fi
}

# =============================================================================
# æŸ¥åˆ†åŠŸèƒ½
# =============================================================================

# æŸ¥è¯¢åˆ†æ•°å’Œå¥–åŠ±ï¼ˆåŸºäºåŸæœ‰çš„PythonæŸ¥åˆ†è„šæœ¬é€»è¾‘ï¼‰
query_score_and_reward() {
    local peer_name="$1"
    
    # æ£€æŸ¥Python3æ˜¯å¦å¯ç”¨
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 æœªå®‰è£…ï¼Œæ— æ³•è¿›è¡ŒæŸ¥åˆ†"
        echo "N/A:N/A:false"
        return 1
    fi
    
    # URLç¼–ç èŠ‚ç‚¹åç§°
    local encoded_name=$(python3 -c "
import urllib.parse
import sys
try:
    print(urllib.parse.quote('$peer_name'))
except Exception as e:
    print('$peer_name')
" 2>/dev/null)
    
    if [[ -z "$encoded_name" ]]; then
        log_error "URLç¼–ç å¤±è´¥"
        echo "N/A:N/A:false"
        return 1
    fi
    
    # APIè°ƒç”¨
    local api_url="https://dashboard.gensyn.ai/api/v1/peer?name=$encoded_name"
    local response=$(curl -s -H "Accept: application/json" \
        -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36" \
        --connect-timeout 10 \
        --max-time 30 \
        "$api_url" 2>/dev/null)
    
    if [[ $? -eq 0 ]] && [[ -n "$response" ]]; then
        # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é”™è¯¯
        if echo "$response" | grep -q "error\|Error\|404"; then
            log_error "APIå“åº”åŒ…å«é”™è¯¯: $response"
            echo "N/A:N/A:false"
            return 1
        fi
        
        # è§£æJSONå“åº”
        local score=$(echo "$response" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(data.get('score', 'N/A'))
except Exception as e:
    print('N/A')
" 2>/dev/null)
        
        local reward=$(echo "$response" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(data.get('reward', 'N/A'))
except Exception as e:
    print('N/A')
" 2>/dev/null)
        
        local online=$(echo "$response" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print('true' if data.get('online', False) else 'false')
except Exception as e:
    print('false')
" 2>/dev/null)
        
        # è¿”å›æ ¼å¼: score:reward:online
        echo "$score:$reward:$online"
    else
        log_error "APIè°ƒç”¨å¤±è´¥æˆ–è¿”å›ç©ºå“åº”"
        echo "N/A:N/A:false"
        return 1
    fi
}

# æ£€æŸ¥åˆ†æ•°å˜åŒ–
check_score_change() {
    local peer_name="$1"
    
    # æ£€æŸ¥ç½‘ç»œè¿æ¥
    if ! check_network_connectivity; then
        log_error "ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè·³è¿‡æœ¬æ¬¡æŸ¥åˆ†"
        return 0  # ç½‘ç»œé—®é¢˜ä¸è§¦å‘é‡å¯
    fi
    
    local state=$(load_state)
    local last_score=$(echo "$state" | grep -oP '"last_score":\s*"\K[^"]*')
    local last_reward=$(echo "$state" | grep -oP '"last_reward":\s*"\K[^"]*')
    local unchanged_count=$(echo "$state" | grep -oP '"unchanged_count":\s*\K[0-9]+')
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å¯åŠ¨ï¼Œå¦‚æœæœ‰åˆ™é‡ç½®è®¡æ•°å™¨
    if check_new_startup; then
        log_info "æ£€æµ‹åˆ°æ–°çš„å¯åŠ¨ï¼Œé‡ç½®åˆ†æ•°å˜åŒ–è®¡æ•°å™¨"
        unchanged_count=0
    fi
    
    # æŸ¥è¯¢å½“å‰åˆ†æ•°å’Œå¥–åŠ±
    local result=$(query_score_and_reward "$peer_name")
    local current_score=$(echo "$result" | cut -d: -f1)
    local current_reward=$(echo "$result" | cut -d: -f2)
    local online_status=$(echo "$result" | cut -d: -f3)
    local current_time=$(date '+%Y-%m-%d %H:%M:%S')
    
    # å¦‚æœæŸ¥åˆ†å¤±è´¥ï¼Œä¸è§¦å‘é‡å¯
    if [[ "$current_score" == "N/A" ]]; then
        log_warn "æŸ¥åˆ†å¤±è´¥ï¼Œè·³è¿‡æœ¬æ¬¡æ£€æŸ¥"
        return 0
    fi
    
    log_info "å½“å‰åˆ†æ•°: $current_score, ä¸Šæ¬¡åˆ†æ•°: $last_score"
    log_info "å½“å‰å¥–åŠ±: $current_reward, ä¸Šæ¬¡å¥–åŠ±: $last_reward"
    log_info "åœ¨çº¿çŠ¶æ€: $online_status"
    
    # æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿
            if [[ "$online_status" == "false" ]]; then
        log_error "è®¾å¤‡ç¦»çº¿ï¼Œè§¦å‘é‡å¯"
        send_telegram_message "è®¾å¤‡ç¦»çº¿ï¼Œè§¦å‘é‡å¯
å½“å‰åˆ†æ•°: $current_score
å½“å‰å¥–åŠ±: $current_reward
åœ¨çº¿çŠ¶æ€: ç¦»çº¿"
        
        save_state "$peer_name" "$current_score" "$current_time" "$unchanged_count" "$current_reward"
        return 1  # éœ€è¦é‡å¯
    fi
    
    # æ£€æŸ¥åˆ†æ•°æ˜¯å¦æ— å˜åŒ–
    if [[ "$current_score" == "$last_score" ]]; then
        unchanged_count=$((unchanged_count + 1))
        log_warn "åˆ†æ•°æœªå˜åŒ–ï¼Œè¿ç»­ $unchanged_count æ¬¡"
        
        if [[ $unchanged_count -ge $SCORE_UNCHANGED_THRESHOLD ]]; then
            log_error "åˆ†æ•°è¿ç»­ $unchanged_count å°æ—¶æœªå˜åŒ–ï¼Œè§¦å‘é‡å¯"
            send_telegram_message "åˆ†æ•°è¿ç»­ $unchanged_count å°æ—¶æœªå˜åŒ–ï¼Œè§¦å‘é‡å¯
å½“å‰åˆ†æ•°: $current_score
å½“å‰å¥–åŠ±: $current_reward
è¿ç»­æœªå˜åŒ–æ¬¡æ•°: $unchanged_count"
            
            # é‡ç½®è®¡æ•°å™¨å¹¶è§¦å‘é‡å¯
            unchanged_count=0
            save_state "$peer_name" "$current_score" "$current_time" "$unchanged_count" "$current_reward"
            return 1  # éœ€è¦é‡å¯
        fi
    else
        log_info "åˆ†æ•°æœ‰å˜åŒ–ï¼Œé‡ç½®è®¡æ•°å™¨"
        unchanged_count=0
    fi
    
    save_state "$peer_name" "$current_score" "$current_time" "$unchanged_count" "$current_reward"
    return 0  # ä¸éœ€è¦é‡å¯
}

# =============================================================================
# ä¸»è¦å¤„ç†å‡½æ•°
# =============================================================================

# å¤„ç†P2Pè¿æ¥é”™è¯¯
handle_p2p_error() {
    local retry_count=0
    
    while [[ $retry_count -lt $MAX_P2P_RETRIES ]]; do
        log_warn "æ£€æµ‹åˆ°P2Pè¿æ¥é”™è¯¯ï¼Œå°è¯•é‡å¯ (${retry_count}/${MAX_P2P_RETRIES})"
        
        # åœ¨screenå†…éƒ¨é‡å¯
        restart_in_screen
        
        # ç­‰å¾…å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ
        local wait_time=0
        while [[ $wait_time -lt 120 ]]; do
            if check_startup_success; then
                log_info "P2Pè¿æ¥é‡å¯æˆåŠŸ"
                return 0
            fi
            sleep 10
            wait_time=$((wait_time + 10))
        done
        
        retry_count=$((retry_count + 1))
    done
    
    log_error "P2Pè¿æ¥é‡å¯å¤±è´¥ï¼Œå·²å°è¯• $MAX_P2P_RETRIES æ¬¡"
    send_telegram_message "P2Pè¿æ¥é‡å¯å¤±è´¥ï¼Œå·²å°è¯• $MAX_P2P_RETRIES æ¬¡ï¼Œéœ€è¦äººå·¥å¤„ç†"
    return 1
}

# å¤„ç†å¯åŠ¨æµç¨‹
handle_startup() {
    log_info "å¼€å§‹å¯åŠ¨ç›‘æ§"
    
    # æ£€æŸ¥screenä¼šè¯
    if ! check_screen_session; then
        log_info "Screenä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä¼šè¯"
        create_screen_session
    else
        log_info "Screenä¼šè¯å·²å­˜åœ¨"
    fi
    
    # ç«‹å³æ£€æŸ¥æ˜¯å¦å·²ç»å¯åŠ¨æˆåŠŸï¼ˆå¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ç¨‹åºï¼‰
    if check_startup_success; then
        local peer_name=$(extract_peer_name)
        log_info "å¯åŠ¨æˆåŠŸï¼åŠ¨ç‰©åç§°: $peer_name"
        
        # éªŒè¯åç§°
        if validate_peer_name "$peer_name"; then
            log_info "åŠ¨ç‰©åç§°éªŒè¯é€šè¿‡: $peer_name"
            local startup_time=$(get_last_startup_time)
            save_state "$peer_name" "" "$(date '+%Y-%m-%d %H:%M:%S')" 0 "" "$startup_time"
            send_telegram_message "ç›‘æ§è„šæœ¬å·²å¯åŠ¨å¹¶æ­£å¸¸è¿è¡Œ
å½“å‰çŠ¶æ€: æ­£å¸¸è¿è¡Œ
ç›‘æ§åŠŸèƒ½: å·²æ¿€æ´»"
            return 0
        else
            log_error "åŠ¨ç‰©åç§°éªŒè¯å¤±è´¥: $peer_name"
            send_telegram_message "åŠ¨ç‰©åç§°éªŒè¯å¤±è´¥ï¼
è¯¥åç§°ä¸åœ¨é¢„è®¾åå•ä¸­ï¼Œè¯·æ£€æŸ¥è´¦å·é…ç½®"
            return 1
        fi
    fi
    
    # å¦‚æœæ²¡æœ‰ç«‹å³æ£€æµ‹åˆ°æˆåŠŸï¼Œç­‰å¾…æ–°çš„å¯åŠ¨
    log_info "ç­‰å¾…ç¨‹åºå¯åŠ¨..."
    local wait_time=0
    while [[ $wait_time -lt 300 ]]; do
        if check_startup_success; then
            local peer_name=$(extract_peer_name)
            log_info "å¯åŠ¨æˆåŠŸï¼åŠ¨ç‰©åç§°: $peer_name"
            
            # éªŒè¯åç§°
            if validate_peer_name "$peer_name"; then
                log_info "åŠ¨ç‰©åç§°éªŒè¯é€šè¿‡: $peer_name"
                local startup_time=$(get_last_startup_time)
                save_state "$peer_name" "" "$(date '+%Y-%m-%d %H:%M:%S')" 0 "" "$startup_time"
                send_telegram_message "ç›‘æ§è„šæœ¬å·²å¯åŠ¨å¹¶æ­£å¸¸è¿è¡Œ
å½“å‰çŠ¶æ€: æ­£å¸¸è¿è¡Œ
ç›‘æ§åŠŸèƒ½: å·²æ¿€æ´»"
                return 0
            else
                log_error "åŠ¨ç‰©åç§°éªŒè¯å¤±è´¥: $peer_name"
                send_telegram_message "åŠ¨ç‰©åç§°éªŒè¯å¤±è´¥ï¼
è¯¥åç§°ä¸åœ¨é¢„è®¾åå•ä¸­ï¼Œè¯·æ£€æŸ¥è´¦å·é…ç½®"
                return 1
            fi
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰P2Pé”™è¯¯
        if check_p2p_error; then
            log_warn "å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç°P2Pé”™è¯¯ï¼Œå°è¯•é‡å¯"
            handle_p2p_error
            wait_time=0  # é‡ç½®ç­‰å¾…æ—¶é—´
        fi
        
        sleep 10
        wait_time=$((wait_time + 10))
    done
    
    log_error "å¯åŠ¨è¶…æ—¶ï¼Œæœªèƒ½æˆåŠŸå¯åŠ¨"
    send_telegram_message "Gensynå¯åŠ¨è¶…æ—¶ï¼Œæœªèƒ½æˆåŠŸå¯åŠ¨ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
    return 1
}

# å¥åº·æ£€æŸ¥
health_check() {
    local issues=()
    local is_recovery_period=false
    
    # æ£€æŸ¥æ˜¯å¦åœ¨é‡å¯æ¢å¤æœŸï¼ˆç»™é‡å¯å10åˆ†é’Ÿçš„æ¢å¤æ—¶é—´ï¼‰
    local state=$(load_state)
    local last_restart_time=$(echo "$state" | grep -oP '"last_restart_time":\s*"\K[^"]*')
    if [[ -n "$last_restart_time" ]]; then
        local restart_timestamp=$(date -d "$last_restart_time" +%s 2>/dev/null || echo "0")
        local current_time=$(date +%s)
        local recovery_time=$((current_time - restart_timestamp))
        
        if [[ $recovery_time -lt 600 ]]; then  # 10åˆ†é’Ÿæ¢å¤æœŸ
            is_recovery_period=true
            log_info "é‡å¯æ¢å¤æœŸï¼šå·²è¿‡ ${recovery_time} ç§’ï¼ˆæ¢å¤æœŸ10åˆ†é’Ÿï¼‰"
        fi
    fi
    
    # æ£€æŸ¥screenä¼šè¯
    if ! check_screen_session; then
        issues+=("Screenä¼šè¯ä¸å­˜åœ¨")
        log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šScreenä¼šè¯ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥è¿›ç¨‹
    if ! check_process_running; then
        if [[ "$is_recovery_period" == "true" ]]; then
            log_warn "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šè¿›ç¨‹æœªè¿è¡Œï¼ˆæ¢å¤æœŸå†…ï¼Œå¯èƒ½æ­£åœ¨å¯åŠ¨ï¼‰"
        else
            issues+=("æ ¸å¿ƒè¿›ç¨‹æœªè¿è¡Œ")
            log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ ¸å¿ƒè¿›ç¨‹æœªè¿è¡Œ"
        fi
    fi
    
    # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
    if [[ ! -f "$LOG_FILE" ]]; then
        issues+=("æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨")
        log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
    fi
    
    # æ£€æŸ¥P2Pè¿æ¥é”™è¯¯ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
    if check_p2p_error; then
        issues+=("P2Pè¿æ¥é”™è¯¯")
        log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ£€æµ‹åˆ°P2Pè¿æ¥é”™è¯¯ï¼Œéœ€è¦é‡å¯"
        return 1  # P2Pé”™è¯¯éœ€è¦ç«‹å³å¤„ç†
    fi
    
    # æ£€æŸ¥è®­ç»ƒè¿›åº¦ï¼ˆåœ¨æ¢å¤æœŸå†…æ”¾å®½è¦æ±‚ï¼‰
    if [[ "$is_recovery_period" == "true" ]]; then
        log_info "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ¢å¤æœŸå†…ï¼Œè·³è¿‡è®­ç»ƒè¿›åº¦æ£€æŸ¥"
    else
        if ! check_training_progress; then
            issues+=("è®­ç»ƒè¿›åº¦å¼‚å¸¸")
            log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šè®­ç»ƒè¿›åº¦å¼‚å¸¸ï¼ˆè¶…è¿‡30åˆ†é’Ÿæ— è®­ç»ƒæ´»åŠ¨ï¼‰"
        fi
    fi
    
    # æ£€æŸ¥ä¸¥é‡é”™è¯¯
    if check_critical_errors; then
        issues+=("æ£€æµ‹åˆ°ä¸¥é‡é”™è¯¯")
        log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ£€æµ‹åˆ°å†…å­˜ã€é…ç½®æˆ–ç³»ç»Ÿä¸¥é‡é”™è¯¯"
    fi
    
    # æ£€æŸ¥è¿è¡Œç¨³å®šæ€§ï¼ˆåœ¨æ¢å¤æœŸå†…æ”¾å®½è¦æ±‚ï¼‰
    if [[ "$is_recovery_period" == "true" ]]; then
        log_info "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ¢å¤æœŸå†…ï¼Œè·³è¿‡è¿è¡Œç¨³å®šæ€§æ£€æŸ¥"
    else
        if ! check_runtime_stability; then
            issues+=("ç¨‹åºè¿è¡Œä¸ç¨³å®š")
            log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šç¨‹åºé¢‘ç¹é‡å¯æˆ–å¯åŠ¨åå‡ºç°é”™è¯¯"
        fi
    fi
    
    # æ£€æŸ¥èº«ä»½æ–‡ä»¶å¡ä½é—®é¢˜
    if check_identity_stuck; then
        issues+=("èº«ä»½æ–‡ä»¶ç­‰å¾…è¶…æ—¶")
        log_error "å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼šæ£€æµ‹åˆ°èº«ä»½æ–‡ä»¶ç­‰å¾…è¶…æ—¶ï¼Œéœ€è¦è‡ªåŠ¨ä¿®å¤"
        
        # å°è¯•è‡ªåŠ¨ä¿®å¤
        if auto_copy_identity_files; then
            log_info "èº«ä»½æ–‡ä»¶å·²è‡ªåŠ¨ä¿®å¤ï¼Œç­‰å¾…ç¨‹åºæ¢å¤"
            # ç»™ç¨‹åº2åˆ†é’Ÿæ—¶é—´å¤„ç†èº«ä»½æ–‡ä»¶
            sleep 120
            
            # é‡æ–°æ£€æŸ¥æ˜¯å¦è¿˜å¡ä½
            if ! check_identity_stuck; then
                log_info "èº«ä»½æ–‡ä»¶é—®é¢˜å·²è§£å†³"
                # ç§»é™¤è¿™ä¸ªé—®é¢˜æ ‡è®°ï¼Œå› ä¸ºå·²ç»è§£å†³äº†
                issues=("${issues[@]/èº«ä»½æ–‡ä»¶ç­‰å¾…è¶…æ—¶}")
            fi
        else
            log_error "èº«ä»½æ–‡ä»¶è‡ªåŠ¨ä¿®å¤å¤±è´¥"
        fi
    fi
    
    if [[ ${#issues[@]} -gt 0 ]]; then
        local issue_text=$(IFS=', '; echo "${issues[*]}")
        log_error "å¥åº·æ£€æŸ¥å¤±è´¥: $issue_text"
        return 1
    else
        log_info "å¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    fi
}

# =============================================================================
# ä¸»ç›‘æ§å¾ªç¯
# =============================================================================

main_monitor_loop() {
    log_info "å¼€å§‹ä¸»ç›‘æ§å¾ªç¯"
    
    local last_score_check=0
    local last_health_check=0
    
    while true; do
        local current_time=$(date +%s)
        
        # å¥åº·æ£€æŸ¥
        if [[ $((current_time - last_health_check)) -ge $HEALTH_CHECK_INTERVAL ]]; then
            if ! health_check; then
                log_warn "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•ä¿®å¤"
                
                # æ£€æŸ¥å…·ä½“å¤±è´¥åŸå› å¹¶é‡‡å–ç›¸åº”æªæ–½
                if check_p2p_error; then
                    log_info "å¥åº·æ£€æŸ¥å¤±è´¥åŸå› ï¼šP2Pè¿æ¥é”™è¯¯ï¼Œå¯åŠ¨ä¸“é—¨çš„P2Pä¿®å¤æµç¨‹"
                    
                    # P2Pé”™è¯¯ä¸“é—¨å¤„ç†
                    local p2p_retry_count=0
                    local max_p2p_retries=10  # ç»™æ›´å¤šé‡è¯•æœºä¼š
                    
                    while [[ $p2p_retry_count -lt $max_p2p_retries ]]; do
                        p2p_retry_count=$((p2p_retry_count + 1))
                        log_warn "P2Pé”™è¯¯ä¿®å¤å°è¯• ${p2p_retry_count}/${max_p2p_retries}"
                        
                        restart_in_screen
                        
                        # ç»™P2Pè¿æ¥æ›´å¤šæ—¶é—´
                        local p2p_wait=0
                        local p2p_fixed=false
                        
                                                 while [[ $p2p_wait -lt 180 ]]; do  # ç­‰å¾…3åˆ†é’Ÿ
                             sleep 30
                             p2p_wait=$((p2p_wait + 30))
                             
                             # ä¼˜å…ˆæ£€æŸ¥èº«ä»½æ–‡ä»¶é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´P2Pé”™è¯¯çš„æ ¹æœ¬åŸå› ï¼‰
                             if check_identity_stuck; then
                                 log_info "P2Pé”™è¯¯æœŸé—´å‘ç°èº«ä»½æ–‡ä»¶é—®é¢˜ï¼Œä¼˜å…ˆä¿®å¤èº«ä»½æ–‡ä»¶"
                                 if auto_copy_identity_files; then
                                     log_info "èº«ä»½æ–‡ä»¶å·²ä¿®å¤ï¼Œç»§ç»­ç­‰å¾…P2Pè¿æ¥"
                                     sleep 60  # ç»™èº«ä»½æ–‡ä»¶å¤„ç†æ—¶é—´
                                 fi
                             fi
                             
                             if ! check_p2p_error; then
                                 log_info "P2Pé”™è¯¯å·²ä¿®å¤ï¼"
                                 p2p_fixed=true
                                 break
                             else
                                 log_warn "P2Pé”™è¯¯ä»å­˜åœ¨ï¼Œç»§ç»­ç­‰å¾…... ($p2p_wait/180ç§’)"
                             fi
                         done
                        
                        if [[ "$p2p_fixed" == "true" ]]; then
                            break
                        fi
                    done
                    
                    if [[ $p2p_retry_count -ge $max_p2p_retries ]]; then
                        log_error "P2Pé”™è¯¯ä¿®å¤å¤±è´¥ï¼Œå·²å°è¯• $max_p2p_retries æ¬¡"
                        send_telegram_message "P2Pè¿æ¥æŒç»­é”™è¯¯ï¼Œå·²å°è¯•ä¿®å¤ $max_p2p_retries æ¬¡ï¼Œéœ€è¦äººå·¥å¤„ç†"
                    fi
                    
                else
                    # éP2Pé”™è¯¯çš„å¸¸è§„å¤„ç†
                    log_info "å¥åº·æ£€æŸ¥å¤±è´¥åŸå› ï¼šéP2Pé”™è¯¯ï¼Œè¿›è¡Œå¸¸è§„é‡å¯"
                    
                    if check_screen_session; then
                        restart_in_screen
                    else
                        create_screen_session
                    fi
                    
                    # é‡å¯åè¿›å…¥æ¢å¤æœŸ
                    log_info "é‡å¯å®Œæˆï¼Œè¿›å…¥10åˆ†é’Ÿæ¢å¤æœŸ..."
                    local recovery_start=$(date +%s)
                    
                    while true; do
                        local recovery_elapsed=$(($(date +%s) - recovery_start))
                        
                        if [[ $recovery_elapsed -gt 600 ]]; then  # 10åˆ†é’Ÿæ¢å¤æœŸ
                            log_warn "æ¢å¤æœŸç»“æŸï¼Œç»§ç»­æ­£å¸¸ç›‘æ§"
                            break
                        fi
                        
                        # æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æ¢å¤çŠ¶æ€
                        if [[ $((recovery_elapsed % 60)) -eq 0 ]]; then
                            log_info "æ¢å¤æœŸçŠ¶æ€æ£€æŸ¥ï¼šå·²è¿‡ $recovery_elapsed ç§’"
                            
                                                         # åœ¨æ¢å¤æœŸå†…ï¼Œä¼˜å…ˆæ£€æŸ¥P2Pé”™è¯¯
                             if check_p2p_error; then
                                 log_warn "æ¢å¤æœŸå‘ç°P2Pé”™è¯¯ï¼Œé‡æ–°å¯åŠ¨"
                                 restart_in_screen
                                 sleep 60
                             elif check_identity_stuck; then
                                 log_warn "æ¢å¤æœŸå‘ç°èº«ä»½æ–‡ä»¶å¡ä½ï¼Œå°è¯•ä¿®å¤"
                                 if auto_copy_identity_files; then
                                     log_info "æ¢å¤æœŸï¼šèº«ä»½æ–‡ä»¶å·²ä¿®å¤ï¼Œç­‰å¾…ç¨‹åºå¤„ç†"
                                     sleep 120  # ç­‰å¾…2åˆ†é’Ÿè®©ç¨‹åºå¤„ç†èº«ä»½æ–‡ä»¶
                                 else
                                     log_error "æ¢å¤æœŸï¼šèº«ä»½æ–‡ä»¶ä¿®å¤å¤±è´¥"
                                 fi
                             elif check_startup_success; then
                                 log_info "æ¢å¤æœŸæ£€æŸ¥ï¼šç¨‹åºå·²æˆåŠŸå¯åŠ¨"
                                 # ä¸ç«‹å³é€€å‡ºæ¢å¤æœŸï¼Œè®©ç¨‹åºç¨³å®šè¿è¡Œä¸€æ®µæ—¶é—´
                             fi
                        fi
                        
                        sleep 30  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
                    done
                fi
            fi
            last_health_check=$current_time
        fi
        
        # æŸ¥åˆ†æ£€æŸ¥
        if [[ $((current_time - last_score_check)) -ge $SCORE_CHECK_INTERVAL ]]; then
            local state=$(load_state)
            local peer_name=$(echo "$state" | grep -oP '"peer_name":\s*"\K[^"]*')
            
            if [[ -n "$peer_name" ]]; then
                if ! check_score_change "$peer_name"; then
                    log_warn "åˆ†æ•°æ£€æŸ¥è§¦å‘é‡å¯"
                    restart_in_screen
                    sleep 30
                fi
            else
                log_warn "æœªæ‰¾åˆ°peeråç§°ï¼Œå°è¯•é‡æ–°æå–"
                peer_name=$(extract_peer_name)
                if [[ -n "$peer_name" ]]; then
                    local startup_time=$(get_last_startup_time)
                    save_state "$peer_name" "" "$(date '+%Y-%m-%d %H:%M:%S')" 0 "" "$startup_time"
                fi
            fi
            last_score_check=$current_time
        fi
        
        # P2Pé”™è¯¯æ£€æŸ¥å·²é›†æˆåˆ°å¥åº·æ£€æŸ¥ä¸­ï¼Œä¸éœ€è¦å•ç‹¬æ£€æŸ¥
        
        sleep $LOG_CHECK_INTERVAL
    done
}

# =============================================================================
# ä¿¡å·å¤„ç†å’Œæ¸…ç†
# =============================================================================

cleanup() {
    log_info "ç›‘æ§è„šæœ¬æ­£åœ¨é€€å‡º..."
    exit 0
}

trap cleanup EXIT SIGINT SIGTERM

# =============================================================================
# ä¸»å‡½æ•°
# =============================================================================

main() {
    log_info "Gensynç›‘æ§è„šæœ¬å¯åŠ¨"
    log_info "å·¥ä½œç›®å½•: $GENSYN_DIR"
    log_info "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    log_info "Screenä¼šè¯: $SCREEN_SESSION"
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    mkdir -p "$(dirname "$MONITOR_LOG")"
    mkdir -p "$(dirname "$STATE_FILE")"
    
    # åˆå§‹åŒ–å¯åŠ¨
    if ! handle_startup; then
        log_error "åˆå§‹åŒ–å¯åŠ¨å¤±è´¥"
        exit 1
    fi
    
    # å¼€å§‹ä¸»ç›‘æ§å¾ªç¯
    main_monitor_loop
}

# è°ƒè¯•å‡½æ•° - æ˜¾ç¤ºå¯åŠ¨æ—¶é—´ä¿¡æ¯
debug_startup_info() {
    local current_startup_time=$(get_last_startup_time)
    local startup_date=$(date -d "@$current_startup_time" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "æ— æ³•è§£æ")
    local state=$(load_state)
    local saved_startup_time=$(echo "$state" | grep -oP '"last_startup_time":\s*"\K[^"]*')
    local saved_startup_date=$(date -d "@$saved_startup_time" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "æ— æ³•è§£æ")
    
    echo "=== å¯åŠ¨æ—¶é—´è°ƒè¯•ä¿¡æ¯ ==="
    echo "å½“å‰æ—¥å¿—ä¸­çš„å¯åŠ¨æ—¶é—´: $startup_date (æ—¶é—´æˆ³: $current_startup_time)"
    echo "çŠ¶æ€æ–‡ä»¶ä¸­çš„å¯åŠ¨æ—¶é—´: $saved_startup_date (æ—¶é—´æˆ³: $saved_startup_time)"
    
    if [[ "$current_startup_time" != "$saved_startup_time" ]]; then
        echo "çŠ¶æ€: æ£€æµ‹åˆ°æ–°çš„å¯åŠ¨"
    else
        echo "çŠ¶æ€: å¯åŠ¨æ—¶é—´ä¸€è‡´"
    fi
    
    echo "åŠ¨ç‰©åç§°: $(extract_peer_name)"
    echo "=========================="
}

# å¿«é€ŸçŠ¶æ€æ£€æŸ¥å‡½æ•°
quick_status_check() {
    echo "=== å¿«é€ŸçŠ¶æ€æ£€æŸ¥ ==="
    echo "æ—¶é—´: $(date)"
    echo ""
    
    echo "Screenä¼šè¯:"
    screen -list | grep gensyn || echo "  æ— gensynä¼šè¯"
    echo ""
    
    echo "è¿›ç¨‹çŠ¶æ€:"
    ps aux | grep -E "(python.*rgym|yarn.*start)" | grep -v grep || echo "  æ— ç›¸å…³è¿›ç¨‹"
    echo ""
    
    echo "æ—¥å¿—æ–‡ä»¶:"
    if [[ -f "$LOG_FILE" ]]; then
        echo "  å­˜åœ¨: $LOG_FILE"
        echo "  æœ€å10è¡Œ:"
        tail -10 "$LOG_FILE" | sed 's/^/    /'
    else
        echo "  ä¸å­˜åœ¨: $LOG_FILE"
    fi
    echo ""
    
    echo "P2Pé”™è¯¯æ£€æŸ¥:"
    if check_p2p_error; then
        echo "  âŒ æ£€æµ‹åˆ°P2Pé”™è¯¯"
        tail -20 "$LOG_FILE" | grep "P2PDaemonError" | tail -3 | sed 's/^/    /'
    else
        echo "  âœ… æ— P2Pé”™è¯¯"
    fi
    echo ""
    
    echo "å¯åŠ¨çŠ¶æ€:"
    if check_startup_success; then
        echo "  âœ… å¯åŠ¨æˆåŠŸ"
        echo "  åŠ¨ç‰©åç§°: $(extract_peer_name)"
    else
        echo "  âŒ å¯åŠ¨æœªæˆåŠŸ"
    fi
    echo ""
    
    echo "è®­ç»ƒè¿›åº¦:"
    if check_training_progress; then
        echo "  âœ… è®­ç»ƒæ­£å¸¸"
    else
        echo "  âŒ è®­ç»ƒå¼‚å¸¸"
    fi
    echo ""
    
    echo "èº«ä»½æ–‡ä»¶çŠ¶æ€:"
    if check_identity_stuck; then
        echo "  âŒ èº«ä»½æ–‡ä»¶ç­‰å¾…è¶…æ—¶"
        echo "  æ£€æŸ¥å¤‡ä»½æ–‡ä»¶:"
        if [[ -f "/root/rl-swarm-backup/userApiKey.json" ]] && [[ -f "/root/rl-swarm-backup/userData.json" ]]; then
            echo "    âœ… å¤‡ä»½æ–‡ä»¶å­˜åœ¨"
        else
            echo "    âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨"
        fi
    else
        echo "  âœ… èº«ä»½æ–‡ä»¶æ­£å¸¸"
    fi
    echo ""
    
    echo "ä¸¥é‡é”™è¯¯æ£€æŸ¥:"
    if check_critical_errors; then
        echo "  âŒ æ£€æµ‹åˆ°ä¸¥é‡é”™è¯¯"
        echo "  æœ€è¿‘é”™è¯¯æ—¥å¿—:"
        tail -50 "$LOG_FILE" | grep -E "ERROR|Error|Exception|Traceback|Failed|failed|InstantiationException|FileNotFoundError" | tail -3 | sed 's/^/    /'
    else
        echo "  âœ… æ— ä¸¥é‡é”™è¯¯"
    fi
    echo ""
    
    echo "è¿è¡Œç¨³å®šæ€§:"
    if check_runtime_stability; then
        echo "  âœ… è¿è¡Œç¨³å®š"
        local current_time=$(date +%s)
        local last_startup_time=$(get_last_startup_time)
        if [[ "$last_startup_time" != "0" ]]; then
            local runtime=$((current_time - last_startup_time))
            echo "  è¿è¡Œæ—¶é•¿: ${runtime}ç§’ ($(($runtime / 60))åˆ†é’Ÿ)"
        fi
    else
        echo "  âŒ è¿è¡Œä¸ç¨³å®š"
        echo "  å¯èƒ½åŸå› : é¢‘ç¹é‡å¯æˆ–å¯åŠ¨åé”™è¯¯"
    fi
    echo "====================="
}

# å‚æ•°å¤„ç†
case "${1:-}" in
    "debug")
        debug_startup_info
        exit 0
        ;;
    "status")
        quick_status_check
        exit 0
        ;;
    "copy-identity")
        echo "=== æ‰‹åŠ¨å¤åˆ¶èº«ä»½æ–‡ä»¶ ==="
        if auto_copy_identity_files; then
            echo "âœ… èº«ä»½æ–‡ä»¶å¤åˆ¶æˆåŠŸ"
        else
            echo "âŒ èº«ä»½æ–‡ä»¶å¤åˆ¶å¤±è´¥"
        fi
        echo "=========================="
        exit 0
        ;;
    "help")
        echo "Gensyn Monitor ä½¿ç”¨è¯´æ˜:"
        echo ""
        echo "  ./gensyn_monitor.sh          # å¯åŠ¨ç›‘æ§"
        echo "  ./gensyn_monitor.sh status   # å¿«é€ŸçŠ¶æ€æ£€æŸ¥"
        echo "  ./gensyn_monitor.sh debug    # å¯åŠ¨æ—¶é—´è°ƒè¯•ä¿¡æ¯"
        echo "  ./gensyn_monitor.sh copy-identity  # æ‰‹åŠ¨å¤åˆ¶èº«ä»½æ–‡ä»¶"
        echo "  ./gensyn_monitor.sh help     # æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
        echo ""
        exit 0
        ;;
esac

# è¿è¡Œä¸»å‡½æ•°
main "$@" 